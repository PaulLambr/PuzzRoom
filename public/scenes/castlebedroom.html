<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>J Quest - Castle Bedroom</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
    <script src="sharedtest3.js"></script> <!-- Reference to sharedtest3.js -->
</head>
<body>
    <script>
        const configBridge = {
            type: Phaser.CANVAS,
            width: 1800,
            height: 1300,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 },
                    debug: false
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        window.game = new Phaser.Game(configBridge);

        let sprite;
        let cursors;
        let rectangleZone2; // Zone to display message about King Graham
        let rectangleZone; // Zone to acquire the mirror
        let mirrorAddedToInventory = false; // Track if mirror is added to inventory
        let hashmarkGraphics; // Hashmark graphics
        let hashmarkText = []; // Hashmark text storage
        let hashmarksVisible = false; // Initially hide hashmarks

        const inventoryPanel = { x: 1500, y: 0, width: 300, height: 900 }; // Adjust as per your panel

        function preload() {
            this.load.image('background', 'graphics/bedroom_shadow.png');
            this.load.image('parchment_bg', 'graphics/parchment_bg.png');
            this.load.spritesheet('character', 'graphics/grahamprincesspng.png', { frameWidth: 28.5, frameHeight: 70 });
            this.load.image('amulet', 'graphics/graks_amulet.png');
            this.load.image('rope', 'graphics/rope.png');
            this.load.image('mirror', 'graphics/mirror.png');

            fetch('inventory-library.json')
                .then(response => response.json())
                .then(data => {
                    data.items.forEach(item => {
                        this.load.image(item.name, item.img);
                    });
                })
                .catch(error => console.error('Error loading inventory library:', error));
        }

        function create() {
            gameInstance = this; // Set gameInstance to the current scene

            this.add.image(750, 450, 'background'); // Center the background in the game window

            const savedX = localStorage.getItem('spriteX');
            const savedY = localStorage.getItem('spriteY');
            const startX = savedX ? parseFloat(savedX) : 100;
            const startY = savedY ? parseFloat(savedY) : 525;

            sprite = this.physics.add.sprite(startX, startY, 'character');
            sprite.setScale(3); // Scale up the sprite

            this.anims.create({
                key: 'walk',
                frames: this.anims.generateFrameNumbers('character', { start: 0, end: 5 }),
                frameRate: 10,
                repeat: -1
            });

            cursors = this.input.keyboard.createCursorKeys();

            // Create an interactive zone to show a message about King Graham
            rectangleZone2 = this.add.zone(1190, 150, 150, 200).setRectangleDropZone(150, 200);
            rectangleZone2.setInteractive();

            rectangleZone2.on('pointerdown', () => {
                showMessage("This is your dad, King Graham. Sadly he disappeared last summer hunting goblins in the Fearful Forest near the Misty Mountains. Many brave knights went in search of him with no luck thus far.", this);
            });

            // Create an interactive rectangular zone for the mirror
            rectangleZone = this.add.zone(800, 310, 100, 60).setRectangleDropZone(100, 60);
            rectangleZone.setInteractive();

            rectangleZone.on('pointerdown', () => {
                if (!mirrorAddedToInventory) {
                    inventory.addItem({ name: 'mirror', img: 'mirror' });
                    showMessage("You pick up your handy-dandy hand mirror.", this);

                    const brownBoxGraphics = this.add.graphics();
                    brownBoxGraphics.fillStyle(0x7f2100, 1);
                    brownBoxGraphics.fillRect(750, 290, 100, 45); // Draw the brown box
                    rectangleZone.destroy(); // Remove the mirror zone
                    mirrorAddedToInventory = true;
                }
            });

            createInventory(this);

            if (inventory.items.find(item => item.name === 'mirror')) {
                const brownBoxGraphics = this.add.graphics();
                brownBoxGraphics.fillStyle(0x7f2100, 1);
                brownBoxGraphics.fillRect(750, 290, 100, 45);
                rectangleZone.destroy(); // Remove the mirror zone
                mirrorAddedToInventory = true;
            }

            hashmarkGraphics = this.add.graphics();
            this.input.keyboard.on('keydown-H', toggleHashmarks, this);

            // Enable drag and drop for inventory items
            this.input.on('dragstart', (pointer, gameObject) => {
                gameObject.setScale(0.28); // Scale up slightly when dragging starts
                gameObject.originalX = gameObject.x; // Store the original X position
                gameObject.originalY = gameObject.y; // Store the original Y position
            });

            this.input.on('drag', (pointer, gameObject, dragX, dragY) => {
                gameObject.x = dragX;
                gameObject.y = dragY;
            });

            this.input.on('dragend', (pointer, gameObject) => {
                gameObject.setScale(0.15); // Restore the original scale

                const itemBounds = gameObject.getBounds();

                if (
                    itemBounds.right <= inventoryPanel.x + inventoryPanel.width &&
                    itemBounds.left >= inventoryPanel.x &&
                    itemBounds.bottom <= inventoryPanel.y + inventoryPanel.height &&
                    itemBounds.top >= inventoryPanel.y
                ) {
                    return; // If the item is dropped inside the inventory, do nothing
                } else {
                    if (pointer.isDown) {
                        showMessage("You can't drop the item here!", this);
                    }

                    gameObject.x = gameObject.originalX;
                    gameObject.y = gameObject.originalY;
                }
            });

            
             checkIntroMessage(this, "castleBedroom", "Ah what a bright shining morning it is in the Kingdom of Kenmoria. You have just awoken, but instead of the pleasant trills of songbirds greeting your ears, it seems like a din of clashing metal and harsh grunting sounds waft through the tower of the castle where you reside.");

        }

        let hasTransitioned = false;  // Flag to prevent multiple transitions

        function update() {
            let moving = false;
            if (cursors.left.isDown) {
                sprite.setVelocityX(-200);
                sprite.setFlipX(true);
                moving = true;
            } else if (cursors.right.isDown) {
                sprite.setVelocityX(200);
                sprite.setFlipX(false);
                moving = true;
            } else {
                sprite.setVelocityX(0);
            }

            if (cursors.up.isDown) {
                sprite.setVelocityY(-200);
                moving = true;
            } else if (cursors.down.isDown) {
                sprite.setVelocityY(200);
                moving = true;
            } else {
                sprite.setVelocityY(0);
            }

            if (sprite.y < 350) {
                sprite.y = 350;
            }

            if (sprite.x > 1500 && !hasTransitioned) {
                localStorage.setItem('spriteX', sprite.x - 1480);
                localStorage.setItem('spriteY', sprite.y);
                hasTransitioned = true;
                window.location.href = "tower.html"; // Transition to the next scene
            }

            if (moving) {
                sprite.anims.play('walk', true);
            } else {
                sprite.setVelocity(0, 0);
                sprite.anims.stop();
                sprite.setFrame(1);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (window.game && inventoryContainer) {
                inventory.loadInventoryState();
            } else {
                console.error("Game instance or inventory container is not initialized.");
            }
        });
    </script>
</body>
</html>
